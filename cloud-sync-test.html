<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAMS - Cloud Sync Test</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 20px; 
            background: #f5f5f5; 
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
            font-weight: bold; 
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        button { 
            padding: 10px 15px; 
            margin: 5px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-weight: bold; 
        }
        .primary { background: #007bff; color: white; }
        .secondary { background: #6c757d; color: white; }
        .danger { background: #dc3545; color: white; }
        #log { 
            background: #f8f9fa; 
            border: 1px solid #dee2e6; 
            border-radius: 4px; 
            padding: 15px; 
            margin: 10px 0; 
            max-height: 300px; 
            overflow-y: auto; 
            font-family: monospace; 
            font-size: 12px; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ LAMS Cloud Sync Test</h1>
        <p>This page tests the new cloud-first architecture with real-time synchronization.</p>

        <div id="authStatus" class="status info">üîê Not authenticated</div>
        <div id="syncStatus" class="status info">‚è∏Ô∏è Sync not started</div>

        <div>
            <button id="signInBtn" class="primary">üîê Sign In</button>
            <button id="startSyncBtn" class="secondary" disabled>üîÑ Start Real-Time Sync</button>
            <button id="stopSyncBtn" class="danger" disabled>‚èπÔ∏è Stop Sync</button>
            <button id="manualSyncBtn" class="secondary" disabled>‚ö° Manual Sync</button>
            <button id="clearLogBtn" class="secondary">üóëÔ∏è Clear Log</button>
        </div>

        <h3>üìä Sync Log</h3>
        <div id="log"></div>

        <h3>üìà Test Statistics</h3>
        <ul>
            <li><strong>Sync Attempts:</strong> <span id="syncAttempts">0</span></li>
            <li><strong>Successful Syncs:</strong> <span id="successfulSyncs">0</span></li>
            <li><strong>Failed Syncs:</strong> <span id="failedSyncs">0</span></li>
            <li><strong>Current Version:</strong> <span id="currentVersion">0</span></li>
            <li><strong>Last Sync:</strong> <span id="lastSync">Never</span></li>
        </ul>
    </div>

    <script src="config.js"></script>
    <script src="auth.js"></script>
    <script src="app.js"></script>
    <script>
        let syncAttempts = 0;
        let successfulSyncs = 0;
        let failedSyncs = 0;

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('log');
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStats() {
            document.getElementById('syncAttempts').textContent = syncAttempts;
            document.getElementById('successfulSyncs').textContent = successfulSyncs;
            document.getElementById('failedSyncs').textContent = failedSyncs;
            document.getElementById('currentVersion').textContent = dataManager?.version || 0;
            document.getElementById('lastSync').textContent = dataManager?.lastSyncTime 
                ? new Date(dataManager.lastSyncTime).toLocaleString() 
                : 'Never';
        }

        // Initialize
        window.addEventListener('load', async () => {
            log('üöÄ LAMS Cloud Sync Test initialized');
            
            // Check if user is already signed in
            if (authManager.isSignedIn) {
                updateAuthStatus(true);
            }
            
            updateStats();
        });

        function updateAuthStatus(isSignedIn) {
            const status = document.getElementById('authStatus');
            const startBtn = document.getElementById('startSyncBtn');
            const manualBtn = document.getElementById('manualSyncBtn');
            
            if (isSignedIn) {
                status.className = 'status success';
                status.textContent = `‚úÖ Signed in as ${authManager.currentUser?.name}`;
                startBtn.disabled = false;
                manualBtn.disabled = false;
                log(`‚úÖ Authentication successful - ${authManager.currentUser?.email}`);
            } else {
                status.className = 'status info';
                status.textContent = 'üîê Not authenticated';
                startBtn.disabled = true;
                manualBtn.disabled = true;
                log('‚ùå Authentication failed or user signed out');
            }
        }

        // Event Listeners
        document.getElementById('signInBtn').addEventListener('click', async () => {
            log('üîê Attempting to sign in...');
            const success = await authManager.signIn();
            updateAuthStatus(success);
        });

        document.getElementById('startSyncBtn').addEventListener('click', () => {
            log('üîÑ Starting real-time sync...');
            dataManager.startRealTimeSync();
            
            const syncStatus = document.getElementById('syncStatus');
            syncStatus.className = 'status success';
            syncStatus.textContent = 'üîÑ Real-time sync active (10s intervals)';
            
            document.getElementById('startSyncBtn').disabled = true;
            document.getElementById('stopSyncBtn').disabled = false;
        });

        document.getElementById('stopSyncBtn').addEventListener('click', () => {
            log('‚èπÔ∏è Stopping real-time sync...');
            dataManager.stopRealTimeSync();
            
            const syncStatus = document.getElementById('syncStatus');
            syncStatus.className = 'status warning';
            syncStatus.textContent = '‚è∏Ô∏è Real-time sync stopped';
            
            document.getElementById('startSyncBtn').disabled = false;
            document.getElementById('stopSyncBtn').disabled = true;
        });

        document.getElementById('manualSyncBtn').addEventListener('click', async () => {
            log('‚ö° Manual sync triggered...');
            syncAttempts++;
            
            try {
                const result = await dataManager.syncWithCloud();
                if (result) {
                    successfulSyncs++;
                    log('‚úÖ Manual sync completed successfully');
                } else {
                    failedSyncs++;
                    log('‚ö†Ô∏è Manual sync completed with warnings');
                }
            } catch (error) {
                failedSyncs++;
                log(`‚ùå Manual sync failed: ${error.message}`);
            }
            
            updateStats();
        });

        document.getElementById('clearLogBtn').addEventListener('click', () => {
            document.getElementById('log').innerHTML = '';
        });

        // Monitor sync attempts
        const originalSyncMethod = dataManager.syncWithCloud;
        dataManager.syncWithCloud = async function() {
            syncAttempts++;
            log('üîÑ Background sync attempt...');
            
            try {
                const result = await originalSyncMethod.call(this);
                if (result) {
                    successfulSyncs++;
                    log('‚úÖ Background sync successful');
                } else {
                    failedSyncs++;
                    log('‚ö†Ô∏è Background sync completed with warnings');
                }
                updateStats();
                return result;
            } catch (error) {
                failedSyncs++;
                log(`‚ùå Background sync failed: ${error.message}`);
                updateStats();
                throw error;
            }
        };
    </script>
</body>
</html>
