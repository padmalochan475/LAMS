<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAMS Assignment Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        .warning { color: orange; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        #log { background: #f5f5f5; padding: 10px; margin: 10px 0; max-height: 400px; overflow-y: auto; }
        select, input { padding: 5px; margin: 2px; }
        .form-group { margin: 10px 0; }
        .status-display { 
            padding: 10px; 
            background: #e7f3ff; 
            border-radius: 5px; 
            margin: 10px 0;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>🧪 LAMS Assignment & Sync Test</h1>
    
    <div class="test-section">
        <h3>Real-Time Sync Status</h3>
        <div id="syncStatus" class="status-display">Initializing...</div>
        <button onclick="toggleSync()">Toggle Sync</button>
        <button onclick="forceSync()">Force Sync Now</button>
    </div>
    
    <div class="test-section">
        <h3>Test Assignment Creation</h3>
        <div class="form-group">
            <label>Day: </label>
            <select id="testDay">
                <option value="">Select Day</option>
                <option value="Monday">Monday</option>
                <option value="Tuesday">Tuesday</option>
                <option value="Wednesday">Wednesday</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>Time Slot: </label>
            <select id="testTimeSlot">
                <option value="">Select Time</option>
                <option value="9:00-10:00">9:00-10:00</option>
                <option value="10:00-11:00">10:00-11:00</option>
                <option value="11:00-12:00">11:00-12:00</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>Subject: </label>
            <input type="text" id="testSubject" placeholder="Enter subject" />
        </div>
        
        <button onclick="testAssignmentCreation()">Create Test Assignment</button>
        <button onclick="testDropdownBehavior()">Test Dropdown Behavior</button>
    </div>
    
    <div class="test-section">
        <h3>Current Assignments</h3>
        <div id="assignmentCount">Count: 0</div>
        <div id="assignmentList"></div>
        <button onclick="refreshAssignmentDisplay()">Refresh Display</button>
    </div>
    
    <div class="test-section">
        <h3>Test Log</h3>
        <div id="log"></div>
        <button onclick="clearLog()">Clear Log</button>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="config.js"></script>
    <script src="auth.js"></script>
    <script src="app.js"></script>
    
    <script>
        let testDataManager;
        let syncActive = false;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 
                            type === 'warning' ? 'warning' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function updateSyncStatus(status) {
            document.getElementById('syncStatus').textContent = status;
        }

        function initializeTest() {
            try {
                testDataManager = new DataManager();
                log('✅ Test DataManager initialized', 'success');
                
                // Override updateSyncStatus to show in our display
                const originalUpdateSyncStatus = testDataManager.updateSyncStatus;
                testDataManager.updateSyncStatus = function(status) {
                    updateSyncStatus(status);
                    originalUpdateSyncStatus.call(this, status);
                };
                
                refreshAssignmentDisplay();
                
                if (window.authManager && window.authManager.isSignedIn) {
                    testDataManager.startRealTimeSync();
                    syncActive = true;
                    log('🔄 Real-time sync started', 'success');
                } else {
                    log('💡 Sign in to enable sync', 'info');
                }
                
            } catch (e) {
                log(`❌ Failed to initialize test: ${e.message}`, 'error');
            }
        }

        function testAssignmentCreation() {
            log('🧪 Testing assignment creation...', 'info');
            
            if (!testDataManager) {
                log('❌ DataManager not initialized', 'error');
                return;
            }

            const assignment = {
                day: document.getElementById('testDay').value || 'Monday',
                timeSlot: document.getElementById('testTimeSlot').value || '9:00-10:00',
                department: 'Computer Science',
                semester: '1st Semester',
                group: 'Group A',
                subGroup: 'Sub Group 1',
                subject: document.getElementById('testSubject').value || 'Test Subject',
                theoryFaculty: 'Dr. Smith',
                labFaculty: 'Prof. Davis',
                labRoom: 'Lab 1'
            };

            const initialCount = testDataManager.data.assignments.length;
            log(`📊 Before creation: ${initialCount} assignments`, 'info');
            
            try {
                const result = testDataManager.addAssignment(assignment);
                
                if (result) {
                    const newCount = testDataManager.data.assignments.length;
                    log(`✅ Assignment created! Count: ${initialCount} → ${newCount}`, 'success');
                    
                    // Test immediate UI refresh
                    setTimeout(() => {
                        refreshAssignmentDisplay();
                        log('🔄 UI refreshed after creation', 'info');
                    }, 100);
                } else {
                    log('❌ Assignment creation failed', 'error');
                }
            } catch (e) {
                log(`❌ Assignment creation error: ${e.message}`, 'error');
            }
        }

        function testDropdownBehavior() {
            log('🧪 Testing dropdown behavior...', 'info');
            
            const daySelect = document.getElementById('testDay');
            const timeSelect = document.getElementById('testTimeSlot');
            
            log('📝 Opening day dropdown - sync should pause', 'info');
            daySelect.focus();
            
            setTimeout(() => {
                log('📝 Changing day selection', 'info');
                daySelect.value = 'Tuesday';
                daySelect.dispatchEvent(new Event('change'));
                
                setTimeout(() => {
                    log('📝 Opening time dropdown', 'info');
                    timeSelect.focus();
                    
                    setTimeout(() => {
                        log('📝 Changing time selection', 'info');
                        timeSelect.value = '10:00-11:00';
                        timeSelect.dispatchEvent(new Event('change'));
                        
                        setTimeout(() => {
                            log('✅ Dropdown test complete - sync should resume', 'success');
                        }, 1000);
                    }, 1000);
                }, 1000);
            }, 1000);
        }

        function refreshAssignmentDisplay() {
            if (!testDataManager) return;
            
            const count = testDataManager.data.assignments.length;
            document.getElementById('assignmentCount').textContent = `Count: ${count}`;
            
            const listDiv = document.getElementById('assignmentList');
            if (count === 0) {
                listDiv.innerHTML = '<p style="color: #666;">No assignments yet</p>';
            } else {
                listDiv.innerHTML = testDataManager.data.assignments.map((assignment, index) => 
                    `<div style="padding: 5px; margin: 2px; background: #f0f0f0; border-radius: 3px;">
                        ${index + 1}. ${assignment.day} ${assignment.timeSlot} - ${assignment.subject}
                    </div>`
                ).join('');
            }
        }

        function toggleSync() {
            if (!testDataManager) return;
            
            if (syncActive) {
                testDataManager.stopRealTimeSync();
                syncActive = false;
                log('⏸️ Sync stopped', 'warning');
                updateSyncStatus('Sync stopped');
            } else {
                testDataManager.startRealTimeSync();
                syncActive = true;
                log('▶️ Real-time sync started - assignments will sync to all users!', 'success');
                updateSyncStatus('✅ Real-time sync active');
            }
        }

        function forceSync() {
            if (!testDataManager) return;
            
            log('🚀 Forcing immediate sync - sharing with all users...', 'info');
            testDataManager.triggerImmediateSync();
        }

        // Initialize when page loads
        window.addEventListener('load', () => {
            log('🚀 Test page loaded', 'success');
            setTimeout(initializeTest, 1000);
        });
        
        // Monitor dropdown events
        document.addEventListener('focus', (e) => {
            if (e.target.tagName === 'SELECT') {
                log(`🎯 Dropdown focused: ${e.target.id}`, 'info');
            }
        }, true);
        
        document.addEventListener('change', (e) => {
            if (e.target.tagName === 'SELECT') {
                log(`🎯 Dropdown changed: ${e.target.id} = ${e.target.value}`, 'info');
            }
        }, true);
    </script>
</body>
</html>
