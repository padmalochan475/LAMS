<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Institute Lab Management System</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="config.js"></script>
    <script src="security.js"></script>
    <script src="security-enhanced.js"></script>
    <script src="server-validation.js"></script>
    <script src="auth.js"></script>
</head>
<body>
    <!-- Floating orbs for background animation -->
    <div class="floating-orbs">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
        <div class="orb orb-4"></div>
    </div>

    <!-- Main container -->
    <div class="container">
        <header class="header">
            <h1 class="header-title">Institute Lab Management System</h1>
            <div class="header-actions">
                <div id="user-info" class="user-info" style="display: none;">
                    <img id="user-avatar" class="user-avatar" src="" alt="User">
                    <span id="user-name"></span>
                    <button class="btn btn--secondary" onclick="signOut()">Sign Out</button>
                </div>
                <div id="login-section">
                    <div id="g_id_onload"
                         data-callback="handleCredentialResponse"
                         data-auto_prompt="false">
                    </div>
                    <div class="g_id_signin" data-type="standard"></div>
                </div>
                <button class="theme-toggle btn--secondary" id="themeToggle">
                    <span class="theme-icon">üåô</span>
                </button>
            </div>
        </header>

        <!-- Navigation tabs -->
        <nav class="nav-tabs" id="main-nav" style="display: none;">
            <button class="nav-tab active" onclick="showTab('dashboard')">
                <span class="nav-icon">üìä</span>
                Dashboard
            </button>
            <button class="nav-tab" onclick="showTab('assignment')">
                <span class="nav-icon">‚ûï</span>
                Assignment
            </button>
            <button class="nav-tab" onclick="showTab('schedule')">
                <span class="nav-icon">üìÖ</span>
                Schedule
            </button>
            <button class="nav-tab" onclick="showTab('master-data')">
                <span class="nav-icon">‚öôÔ∏è</span>
                Master Data
            </button>
            <button class="nav-tab" onclick="showTab('analytics')">
                <span class="nav-icon">üìà</span>
                Analytics
            </button>
            <button class="nav-tab" onclick="showTab('print')">
                <span class="nav-icon">üñ®Ô∏è</span>
                Print Schedule
            </button>
        </nav>

        <!-- Loading Screen -->
        <div id="loadingScreen" class="loading-screen">
            <div class="loading-content">
                <div class="loading-spinner"></div>
                <p>Validating deployment...</p>
            </div>
        </div>

        <!-- Security Notice -->
        <div class="security-notice" id="securityNotice" style="display: none;">
            <div class="notice-content">
                <span class="notice-icon">‚ö†Ô∏è</span>
                <span class="notice-text">This application is for internal institute use only. All data is stored securely in Google Drive.</span>
                <button class="notice-close" onclick="this.parentElement.parentElement.style.display='none'">&times;</button>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div class="tab-content active" id="dashboard-tab">
            <div class="dashboard-header">
                <h2>Academic Year: <span id="currentAcademicYear" class="academic-year-display" onclick="editAcademicYear()">2024-25</span></h2>
                <div class="dashboard-actions">
                    <button class="btn btn--secondary" onclick="syncWithDrive()" title="Sync with Google Drive">
                        <span class="nav-icon">‚òÅÔ∏è</span> Sync Drive
                    </button>
                    <button class="btn btn--secondary" onclick="exportData()" title="Export Data">
                        <span class="nav-icon">üì•</span> Export
                    </button>
                    <button class="btn btn--secondary admin-btn" onclick="importData()" title="Import Data (Admin Only)">
                        <span class="nav-icon">üì§</span> Import
                    </button>
                    <button class="btn btn--secondary admin-btn" onclick="showUserManagement()" title="Manage Users (Admin Only)">
                        <span class="nav-icon">üë•</span> Users
                        <span id="pendingUsersCount" class="pending-badge" style="display: none;">0</span>
                    </button>
                </div>
            </div>
            <div class="dashboard-grid">
                <div class="stat-card glass-card">
                    <h3>Total Assignments</h3>
                    <div class="stat-number" id="totalAssignments">0</div>
                </div>
                <div class="stat-card glass-card">
                    <h3>Active Faculty</h3>
                    <div class="stat-number" id="totalFaculty">0</div>
                </div>
                <div class="stat-card glass-card">
                    <h3>Lab Rooms</h3>
                    <div class="stat-number" id="totalRooms">0</div>
                </div>
                <div class="stat-card glass-card">
                    <h3>Lab Subjects</h3>
                    <div class="stat-number" id="totalSubjects">0</div>
                </div>
            </div>
            
            <div class="recent-assignments glass-card">
                <h3>Recent Activities</h3>
                <div id="recentAssignmentsList">
                    <p class="empty-state">No assignments created yet. Add master data first, then create assignments.</p>
                </div>
            </div>
            
            <!-- Usage Statistics will be dynamically inserted here -->
            
            <!-- Admin Panel -->
            <div class="admin-panel glass-card admin-only" style="display: none;">
                <h3>Admin Panel</h3>
                <div class="admin-stats">
                    <div class="stat-item">
                        <span class="stat-label">Approved Users</span>
                        <span class="stat-value" id="approvedUsersCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Pending Requests</span>
                        <span class="stat-value" id="pendingRequestsCount">0</span>
                    </div>
                </div>
                <div class="admin-actions">
                    <button class="btn btn--primary" onclick="showUserManagement()">Manage Users</button>
                    <button class="btn btn--outline" onclick="clearAllData()">Clear All Data</button>
                </div>
            </div>
        </div>

        <!-- Assignment Management Tab -->
        <div class="tab-content" id="assignment-tab">
            <div class="glass-card">
                <h2>Create Lab Assignment</h2>
                <form id="assignmentForm" class="assignment-form">
                    <div class="form-section">
                        <h3>Schedule Information</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Day</label>
                                <select class="form-control" id="assignmentDay" required>
                                    <option value="">Select Day</option>
                                    <option value="Monday">Monday</option>
                                    <option value="Tuesday">Tuesday</option>
                                    <option value="Wednesday">Wednesday</option>
                                    <option value="Thursday">Thursday</option>
                                    <option value="Friday">Friday</option>
                                    <option value="Saturday">Saturday</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Time Slot</label>
                                <select class="form-control" id="assignmentTimeSlot" required>
                                    <option value="">Select Time Slot</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Class Information</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Department</label>
                                <select class="form-control" id="assignmentDepartment" required>
                                    <option value="">Select Department</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Semester</label>
                                <select class="form-control" id="assignmentSemester" required>
                                    <option value="">Select Semester</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Group</label>
                                <select class="form-control" id="assignmentGroup" required>
                                    <option value="">Select Group</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Sub Group</label>
                                <select class="form-control" id="assignmentSubGroup" required>
                                    <option value="">Select Sub Group</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Lab Details</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Subject</label>
                                <select class="form-control" id="assignmentSubject" required>
                                    <option value="">Select Subject</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Lab Room</label>
                                <select class="form-control" id="assignmentLabRoom" required>
                                    <option value="">Select Lab Room</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Faculty Assignment</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Theory Faculty</label>
                                <select class="form-control" id="assignmentTheoryFaculty" required>
                                    <option value="">Select Theory Faculty</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Lab Faculty</label>
                                <select class="form-control" id="assignmentLabFaculty" required>
                                    <option value="">Select Lab Faculty</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn--primary">Create Assignment</button>
                        <button type="button" class="btn btn--secondary" id="clearForm">Clear Form</button>
                        <button type="button" class="btn btn--outline" onclick="previewAssignment()">Preview</button>
                    </div>
                </form>
            </div>
            
            <div class="glass-card">
                <h3>Existing Assignments</h3>
                <div class="search-controls">
                    <input type="text" class="form-control" id="assignmentSearch" placeholder="Search assignments...">
                    <div class="search-stats" id="searchStats"></div>
                </div>
                <div id="assignmentsList">
                    <p class="empty-state">No assignments created yet.</p>
                </div>
            </div>
        </div>

        <!-- Lab Schedule Tab -->
        <div class="tab-content" id="schedule-tab">
            <div class="glass-card">
                <h2>Interactive Lab Timetable</h2>
                <div class="schedule-controls">
                    <div class="form-group">
                        <label class="form-label">Filter by Department</label>
                        <select class="form-control" id="scheduleFilter">
                            <option value="">All Departments</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Filter by Semester</label>
                        <select class="form-control" id="scheduleSemesterFilter">
                            <option value="">All Semesters</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Filter by Group</label>
                        <select class="form-control" id="scheduleGroupFilter">
                            <option value="">All Groups</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <button class="btn btn--secondary" onclick="toggleScheduleOrientation()">
                            <span class="nav-icon">üîÑ</span> Swap View
                        </button>
                    </div>
                </div>
                <div id="scheduleGrid" class="schedule-grid">
                    <p class="empty-state">Add time slots and assignments to view the schedule.</p>
                </div>
            </div>
        </div>

        <!-- Master Data Tab -->
        <div class="tab-content" id="master-data-tab">
            <div class="master-data-grid">
                <!-- Departments -->
                <div class="glass-card">
                    <h3>Departments <span class="count-badge" id="departmentsCount">5</span></h3>
                    <div class="master-data-form">
                        <input type="text" class="form-control" id="newDepartment" placeholder="e.g., CSE">
                        <button class="btn btn--primary" onclick="addMasterDataItem('departments', 'newDepartment')">Add</button>
                    </div>
                    <div id="departmentsList" class="master-data-list"></div>
                </div>

                <!-- Semesters -->
                <div class="glass-card">
                    <h3>Semesters <span class="count-badge" id="semestersCount">8</span></h3>
                    <div class="master-data-form">
                        <input type="text" class="form-control" id="newSemester" placeholder="e.g., 1st">
                        <button class="btn btn--primary" onclick="addMasterDataItem('semesters', 'newSemester')">Add</button>
                    </div>
                    <div id="semestersList" class="master-data-list"></div>
                </div>

                <!-- Groups -->
                <div class="glass-card">
                    <h3>Groups <span class="count-badge" id="groupsCount">4</span></h3>
                    <div class="master-data-form">
                        <input type="text" class="form-control" id="newGroup" placeholder="e.g., A">
                        <button class="btn btn--primary" onclick="addMasterDataItem('groups', 'newGroup')">Add</button>
                    </div>
                    <div id="groupsList" class="master-data-list"></div>
                </div>

                <!-- Sub Groups -->
                <div class="glass-card">
                    <h3>Sub Groups <span class="count-badge" id="subGroupsCount">3</span></h3>
                    <div class="master-data-form">
                        <input type="text" class="form-control" id="newSubGroup" placeholder="e.g., 1">
                        <button class="btn btn--primary" onclick="addMasterDataItem('subGroups', 'newSubGroup')">Add</button>
                    </div>
                    <div id="subGroupsList" class="master-data-list"></div>
                </div>

                <!-- Time Slots -->
                <div class="glass-card">
                    <h3>Time Slots <span class="count-badge" id="timeSlotsCount">0</span></h3>
                    <div class="master-data-form">
                        <input type="text" class="form-control" id="newTimeSlot" placeholder="e.g., 09:00-10:00">
                        <button class="btn btn--primary" onclick="addMasterDataItem('timeSlots', 'newTimeSlot')">Add</button>
                    </div>
                    <div id="timeSlotsList" class="master-data-list"></div>
                </div>

                <!-- Subjects -->
                <div class="glass-card">
                    <h3>Subjects <span class="count-badge" id="subjectsCount">0</span></h3>
                    <div class="master-data-form">
                        <input type="text" class="form-control" id="newSubject" placeholder="e.g., OS LAB">
                        <button class="btn btn--primary" onclick="addMasterDataItem('subjects', 'newSubject')">Add</button>
                    </div>
                    <div id="subjectsList" class="master-data-list"></div>
                </div>

                <!-- Lab Rooms -->
                <div class="glass-card">
                    <h3>Lab Rooms <span class="count-badge" id="labRoomsCount">0</span></h3>
                    <div class="master-data-form">
                        <input type="text" class="form-control" id="newLabRoom" placeholder="e.g., L1">
                        <button class="btn btn--primary" onclick="addMasterDataItem('labRooms', 'newLabRoom')">Add</button>
                    </div>
                    <div id="labRoomsList" class="master-data-list"></div>
                </div>

                <!-- Theory Faculty -->
                <div class="glass-card faculty-card">
                    <h3>Theory Faculty <span class="count-badge" id="theoryFacultyCount">0</span></h3>
                    <div class="faculty-form">
                        <div class="form-group">
                            <input type="text" class="form-control" id="newTheoryFacultyShort" placeholder="Short Name (e.g., BS)">
                        </div>
                        <div class="form-group">
                            <input type="text" class="form-control" id="newTheoryFacultyFull" placeholder="Full Name (e.g., BISWAJIT SARANGI)">
                        </div>
                        <div class="form-group">
                            <select class="form-control" id="newTheoryFacultyDept">
                                <option value="">Select Department</option>
                            </select>
                        </div>
                        <button class="btn btn--primary" onclick="addFaculty('theory')">Add Faculty</button>
                    </div>
                    <div id="theoryFacultyList" class="master-data-list"></div>
                </div>

                <!-- Lab Faculty -->
                <div class="glass-card faculty-card">
                    <h3>Lab Faculty <span class="count-badge" id="labFacultyCount">0</span></h3>
                    <div class="faculty-form">
                        <div class="form-group">
                            <input type="text" class="form-control" id="newLabFacultyShort" placeholder="Short Name (e.g., PLM)">
                        </div>
                        <div class="form-group">
                            <input type="text" class="form-control" id="newLabFacultyFull" placeholder="Full Name (e.g., PADMALOCHAN MAHARANA)">
                        </div>
                        <div class="form-group">
                            <select class="form-control" id="newLabFacultyDept">
                                <option value="">Select Department</option>
                            </select>
                        </div>
                        <button class="btn btn--primary" onclick="addFaculty('lab')">Add Faculty</button>
                    </div>
                    <div id="labFacultyList" class="master-data-list"></div>
                </div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div class="tab-content" id="analytics-tab">
            <div class="analytics-grid">
                <div class="glass-card">
                    <h3>Faculty Workload Distribution</h3>
                    <div class="chart-container" style="position: relative; height: 300px;">
                        <canvas id="facultyWorkloadChart"></canvas>
                    </div>
                </div>
                <div class="glass-card">
                    <h3>Subject Popularity</h3>
                    <div class="chart-container" style="position: relative; height: 300px;">
                        <canvas id="subjectDistributionChart"></canvas>
                    </div>
                </div>
                <div class="glass-card">
                    <h3>Room Utilization Analysis</h3>
                    <div class="chart-container" style="position: relative; height: 300px;">
                        <canvas id="roomUtilizationChart"></canvas>
                    </div>
                </div>
                <div class="glass-card">
                    <h3>Department Comparison</h3>
                    <div class="chart-container" style="position: relative; height: 300px;">
                        <canvas id="departmentOverviewChart"></canvas>
                    </div>
                </div>
                <div class="glass-card">
                    <h3>Time Slot Efficiency</h3>
                    <div class="chart-container" style="position: relative; height: 300px;">
                        <canvas id="timeSlotChart"></canvas>
                    </div>
                </div>
                <div class="glass-card">
                    <h3>Weekly Schedule Heatmap</h3>
                    <div class="chart-container" style="position: relative; height: 300px;">
                        <canvas id="heatmapChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Print Tab -->
        <div class="tab-content" id="print-tab">
            <div class="glass-card no-print">
                <h2>Professional A4 Print System</h2>
                <div class="print-controls">
                    <div class="form-group">
                        <label class="form-label">Department Filter</label>
                        <select class="form-control" id="printDepartmentFilter">
                            <option value="">All Departments</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Semester Filter</label>
                        <select class="form-control" id="printSemesterFilter">
                            <option value="">All Semesters</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Group Filter</label>
                        <select class="form-control" id="printGroupFilter">
                            <option value="">All Groups</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <button class="btn btn--secondary" onclick="toggleScheduleOrientation()">
                            <span class="nav-icon">üîÑ</span> Swap View
                        </button>
                    </div>
                    <div class="form-group">
                        <button class="btn btn--secondary" onclick="editAcademicYear()">
                            <span class="nav-icon">üìÖ</span> Edit Academic Year
                        </button>
                    </div>
                    <button class="btn btn--primary" onclick="window.print()">üñ®Ô∏è Print Schedule</button>
                </div>
            </div>
            
            <div id="printSchedule" class="print-schedule">
                <div class="print-header">
                    <div class="institute-header">
                        <h1>INSTITUTE LAB SCHEDULE</h1>
                        <div class="institute-details">
                            <p>Academic Year: <span id="printAcademicYear">2024-25</span></p>
                            <p id="printDepartmentTitle">All Departments</p>
                            <p class="print-date">Generated on: <span id="printDate"></span></p>
                        </div>
                    </div>
                </div>
                <div id="printGrid" class="print-grid">
                    <p class="empty-state">No assignments to print.</p>
                </div>
                <div class="print-footer">
                    <p>For any queries, contact the Lab Coordinator</p>
                </div>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
</body>
</html>