<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAMS - 100% Cloud Verification Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .test-card { background: white; padding: 20px; margin: 15px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .test-title { color: #333; margin-bottom: 15px; font-size: 1.2em; font-weight: bold; }
        .status-good { color: #28a745; }
        .status-bad { color: #dc3545; }
        .status-warning { color: #ffc107; }
        .btn { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .test-output { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 400px; overflow-y: auto; border-left: 4px solid #007bff; }
        .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 15px 0; }
        .metric { background: #e9ecef; padding: 15px; border-radius: 4px; text-align: center; }
        .metric-value { font-size: 24px; font-weight: bold; color: #007bff; }
        .metric-label { font-size: 12px; color: #666; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ LAMS - 100% Cloud System Verification</h1>
        <p><strong>Purpose:</strong> Verify that LAMS is completely cloud-based with zero localStorage dependency for user management.</p>
        
        <div class="test-card">
            <div class="test-title">üîç System Architecture Analysis</div>
            <button class="btn btn-primary" onclick="analyzeArchitecture()">Analyze System Architecture</button>
            <div id="architecture-output" class="test-output"></div>
        </div>
        
        <div class="test-card">
            <div class="test-title">‚òÅÔ∏è Cloud Data Structure Verification</div>
            <button class="btn btn-primary" onclick="verifyCloudStructure()">Check Cloud Data Structure</button>
            <div id="cloud-output" class="test-output"></div>
        </div>
        
        <div class="test-card">
            <div class="test-title">üë• User Management System Test</div>
            <div class="metrics">
                <div class="metric">
                    <div class="metric-value" id="pending-count">0</div>
                    <div class="metric-label">Pending Users (Cloud)</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="approved-count">0</div>
                    <div class="metric-label">Approved Users (Cloud)</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="localStorage-check">‚ùå</div>
                    <div class="metric-label">localStorage Dependency</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="cloud-sync">‚ùå</div>
                    <div class="metric-label">Cloud Sync Status</div>
                </div>
            </div>
            <button class="btn btn-success" onclick="testUserManagement()">Test User Management</button>
            <button class="btn btn-warning" onclick="simulateCloudUser()">Simulate Cloud User</button>
            <button class="btn btn-danger" onclick="clearCloudData()">Clear All Cloud Data</button>
            <div id="user-output" class="test-output"></div>
        </div>
        
        <div class="test-card">
            <div class="test-title">üîÑ Real-Time Sync Verification</div>
            <button class="btn btn-primary" onclick="testRealTimeSync()">Test Real-Time Sync</button>
            <button class="btn btn-success" onclick="monitorSyncActivity()">Monitor Sync Activity</button>
            <div id="sync-output" class="test-output"></div>
        </div>
        
        <div class="test-card">
            <div class="test-title">üìä Final Compliance Report</div>
            <button class="btn btn-primary" onclick="generateComplianceReport()">Generate Compliance Report</button>
            <div id="report-output" class="test-output"></div>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="app.js"></script>
    <script src="auth.js"></script>
    <script>
        let testResults = {};
        let systemInitialized = false;
        
        // Wait for LAMS system to initialize
        function waitForSystemInit() {
            return new Promise((resolve) => {
                const checkInit = () => {
                    if (window.dataManager && window.authManager) {
                        systemInitialized = true;
                        resolve(true);
                    } else {
                        setTimeout(checkInit, 100);
                    }
                };
                checkInit();
            });
        }
        
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            element.innerHTML += `<div>${timestamp} ${icon} ${message}</div>`;
            element.scrollTop = element.scrollHeight;
        }

        function analyzeArchitecture() {
            const output = document.getElementById('architecture-output');
            output.innerHTML = '<div>üîç Analyzing LAMS Architecture...</div>';
            
            if (!systemInitialized) {
                log('architecture-output', '‚è≥ Waiting for LAMS system to initialize...', 'warning');
                waitForSystemInit().then(() => {
                    analyzeArchitecture(); // Retry after initialization
                });
                return;
            }
            
            // Check if DataManager exists
            if (window.dataManager) {
                log('architecture-output', '‚úÖ DataManager instance found', 'success');
                log('architecture-output', `üìä DataManager has pendingUsers: ${!!window.dataManager.pendingUsers}`, 'info');
                log('architecture-output', `üìä DataManager has approvedUsers: ${!!window.dataManager.approvedUsers}`, 'info');
                log('architecture-output', `‚òÅÔ∏è Cloud mode enabled: ${window.dataManager.isCloudMode}`, 'info');
                testResults.dataManagerExists = true;
            } else {
                log('architecture-output', '‚ùå DataManager not found - system not initialized', 'error');
                testResults.dataManagerExists = false;
            }
            
            // Check if AuthManager exists
            if (window.authManager) {
                log('architecture-output', '‚úÖ AuthManager instance found', 'success');
                log('architecture-output', `üîê Signed in: ${window.authManager.isSignedIn}`, 'info');
                testResults.authManagerExists = true;
            } else {
                log('architecture-output', '‚ùå AuthManager not found', 'error');
                testResults.authManagerExists = false;
            }
            
            // Check for localStorage dependencies
            const hasLocalStorageDeps = checkLocalStorageDependencies();
            if (hasLocalStorageDeps.length === 0) {
                log('architecture-output', '‚úÖ No localStorage dependencies found for user management', 'success');
                testResults.noLocalStorageDeps = true;
            } else {
                log('architecture-output', `‚ùå Found localStorage dependencies: ${hasLocalStorageDeps.join(', ')}`, 'error');
                testResults.noLocalStorageDeps = false;
            }
        }

        function checkLocalStorageDependencies() {
            const dependencies = [];
            const userKeys = [CONFIG.PENDING_USERS_KEY, CONFIG.APPROVED_USERS_KEY];
            
            userKeys.forEach(key => {
                if (localStorage.getItem(key)) {
                    dependencies.push(key);
                }
            });
            
            return dependencies;
        }

        function verifyCloudStructure() {
            const output = document.getElementById('cloud-output');
            output.innerHTML = '<div>‚òÅÔ∏è Verifying Cloud Data Structure...</div>';
            
            if (!systemInitialized) {
                log('cloud-output', '‚è≥ Waiting for LAMS system to initialize...', 'warning');
                waitForSystemInit().then(() => {
                    verifyCloudStructure(); // Retry after initialization
                });
                return;
            }
            
            if (!window.dataManager) {
                log('cloud-output', '‚ùå DataManager not available', 'error');
                return;
            }
            
            // Check cloud data structure
            log('cloud-output', 'üìä Cloud Data Structure Analysis:', 'info');
            log('cloud-output', `‚îú‚îÄ‚îÄ pendingUsers: ${JSON.stringify(window.dataManager.pendingUsers || [])}`, 'info');
            log('cloud-output', `‚îú‚îÄ‚îÄ approvedUsers: ${JSON.stringify(window.dataManager.approvedUsers || [])}`, 'info');
            log('cloud-output', `‚îú‚îÄ‚îÄ lastSyncTime: ${window.dataManager.lastSyncTime}`, 'info');
            log('cloud-output', `‚îî‚îÄ‚îÄ version: ${window.dataManager.data?.version || 'N/A'}`, 'info');
            
            // Update metrics
            document.getElementById('pending-count').textContent = (window.dataManager.pendingUsers || []).length;
            document.getElementById('approved-count').textContent = (window.dataManager.approvedUsers || []).length;
            document.getElementById('localStorage-check').textContent = checkLocalStorageDependencies().length === 0 ? '‚úÖ' : '‚ùå';
            document.getElementById('cloud-sync').textContent = window.dataManager.lastSyncTime ? '‚úÖ' : '‚è≥';
            
            testResults.cloudStructureValid = true;
        }

        function testUserManagement() {
            const output = document.getElementById('user-output');
            output.innerHTML = '<div>üë• Testing User Management System...</div>';
            
            if (!window.dataManager) {
                log('user-output', '‚ùå DataManager not available', 'error');
                return;
            }
            
            // Test cloud-based user management
            const initialPending = (window.dataManager.pendingUsers || []).length;
            const initialApproved = (window.dataManager.approvedUsers || []).length;
            
            log('user-output', `üìä Initial state: ${initialPending} pending, ${initialApproved} approved`, 'info');
            
            // Check if functions exist
            if (typeof window.approveUser === 'function') {
                log('user-output', '‚úÖ approveUser function exists (cloud-based)', 'success');
            } else {
                log('user-output', '‚ùå approveUser function not found', 'error');
            }
            
            if (typeof window.rejectUser === 'function') {
                log('user-output', '‚úÖ rejectUser function exists (cloud-based)', 'success');
            } else {
                log('user-output', '‚ùå rejectUser function not found', 'error');
            }
            
            if (typeof window.showUserManagement === 'function') {
                log('user-output', '‚úÖ showUserManagement function exists', 'success');
            } else {
                log('user-output', '‚ùå showUserManagement function not found', 'error');
            }
            
            testResults.userManagementFunctional = true;
        }

        function simulateCloudUser() {
            const output = document.getElementById('user-output');
            
            if (!window.dataManager) {
                log('user-output', '‚ùå DataManager not available for simulation', 'error');
                return;
            }
            
            const testUser = {
                id: 'test_' + Date.now(),
                name: 'Test User ' + Math.floor(Math.random() * 100),
                email: `testuser${Math.floor(Math.random() * 1000)}@example.com`,
                picture: 'https://via.placeholder.com/40',
                loginTime: new Date().toISOString()
            };
            
            log('user-output', `üß™ Simulating cloud user: ${testUser.name} (${testUser.email})`, 'info');
            
            // Add to cloud pending users
            if (!window.dataManager.pendingUsers) {
                window.dataManager.pendingUsers = [];
            }
            
            window.dataManager.pendingUsers.push(testUser);
            
            // Trigger cloud save
            if (window.dataManager.save) {
                window.dataManager.save().then(success => {
                    if (success) {
                        log('user-output', '‚úÖ Test user added to cloud and synced successfully', 'success');
                        verifyCloudStructure(); // Update metrics
                    } else {
                        log('user-output', '‚ùå Failed to sync test user to cloud', 'error');
                    }
                }).catch(error => {
                    log('user-output', `‚ùå Error syncing to cloud: ${error.message}`, 'error');
                });
            } else {
                log('user-output', '‚ùå DataManager.save function not available', 'error');
            }
        }

        function clearCloudData() {
            if (!window.dataManager) {
                log('user-output', '‚ùå DataManager not available', 'error');
                return;
            }
            
            log('user-output', 'üßπ Clearing all cloud user data...', 'warning');
            
            window.dataManager.pendingUsers = [];
            window.dataManager.approvedUsers = [];
            
            window.dataManager.save().then(success => {
                if (success) {
                    log('user-output', '‚úÖ Cloud data cleared and synced', 'success');
                    verifyCloudStructure(); // Update metrics
                } else {
                    log('user-output', '‚ùå Failed to sync cleared data to cloud', 'error');
                }
            }).catch(error => {
                log('user-output', `‚ùå Error clearing cloud data: ${error.message}`, 'error');
            });
        }

        function testRealTimeSync() {
            const output = document.getElementById('sync-output');
            output.innerHTML = '<div>üîÑ Testing Real-Time Sync...</div>';
            
            if (!window.dataManager) {
                log('sync-output', '‚ùå DataManager not available', 'error');
                return;
            }
            
            log('sync-output', 'üîç Checking sync configuration...', 'info');
            log('sync-output', `‚è±Ô∏è Sync interval active: ${!!window.dataManager.syncInterval}`, 'info');
            log('sync-output', `üïí Last sync time: ${window.dataManager.lastSyncTime || 'Never'}`, 'info');
            log('sync-output', `‚òÅÔ∏è Cloud mode: ${window.dataManager.isCloudMode}`, 'info');
            
            if (window.dataManager.startRealTimeSync) {
                log('sync-output', '‚úÖ Real-time sync function available', 'success');
                
                // Test sync trigger
                log('sync-output', 'üöÄ Triggering manual sync test...', 'info');
                window.dataManager.save().then(success => {
                    if (success) {
                        log('sync-output', '‚úÖ Manual sync completed successfully', 'success');
                    } else {
                        log('sync-output', '‚ùå Manual sync failed', 'error');
                    }
                });
            } else {
                log('sync-output', '‚ùå Real-time sync function not available', 'error');
            }
        }

        function monitorSyncActivity() {
            const output = document.getElementById('sync-output');
            let monitorCount = 0;
            
            log('sync-output', 'üëÄ Starting sync activity monitor (30 seconds)...', 'info');
            
            const monitor = setInterval(() => {
                monitorCount++;
                if (window.dataManager) {
                    log('sync-output', `üìä Monitor ${monitorCount}: Last sync: ${window.dataManager.lastSyncTime || 'Never'}`, 'info');
                }
                
                if (monitorCount >= 6) { // 6 checks over 30 seconds
                    clearInterval(monitor);
                    log('sync-output', '‚èπÔ∏è Monitor completed', 'info');
                }
            }, 5000);
        }

        function generateComplianceReport() {
            const output = document.getElementById('report-output');
            output.innerHTML = '<div>üìä Generating 100% Cloud Compliance Report...</div>';
            
            const checks = [
                {
                    name: 'üèóÔ∏è DataManager Architecture',
                    status: !!window.dataManager && !!window.dataManager.pendingUsers && !!window.dataManager.approvedUsers,
                    description: 'DataManager has cloud-based user management properties'
                },
                {
                    name: '‚òÅÔ∏è Cloud Data Structure',
                    status: window.dataManager?.pendingUsers instanceof Array && window.dataManager?.approvedUsers instanceof Array,
                    description: 'User data stored in cloud-based arrays'
                },
                {
                    name: 'üö´ No localStorage Dependency',
                    status: checkLocalStorageDependencies().length === 0,
                    description: 'No user management data in localStorage'
                },
                {
                    name: 'üîÑ Real-Time Sync',
                    status: !!window.dataManager?.save && typeof window.dataManager.save === 'function',
                    description: 'Cloud save functionality available'
                },
                {
                    name: 'üë• Cloud User Functions',
                    status: typeof window.approveUser === 'function' && typeof window.rejectUser === 'function',
                    description: 'User management functions use cloud data'
                },
                {
                    name: 'üîê Authentication Integration',
                    status: !!window.authManager && window.authManager.hasOwnProperty('updatePendingUsersCountFromCloud'),
                    description: 'Auth system integrated with cloud user management'
                }
            ];
            
            let passedChecks = 0;
            checks.forEach(check => {
                const icon = check.status ? '‚úÖ' : '‚ùå';
                const statusText = check.status ? 'PASS' : 'FAIL';
                log('report-output', `${icon} ${check.name}: ${statusText}`, check.status ? 'success' : 'error');
                log('report-output', `   ‚îî‚îÄ‚îÄ ${check.description}`, 'info');
                if (check.status) passedChecks++;
            });
            
            const complianceScore = Math.round((passedChecks / checks.length) * 100);
            const overallStatus = complianceScore >= 90 ? 'EXCELLENT' : complianceScore >= 75 ? 'GOOD' : complianceScore >= 50 ? 'NEEDS IMPROVEMENT' : 'CRITICAL ISSUES';
            
            log('report-output', ``, 'info');
            log('report-output', `üìä COMPLIANCE SCORE: ${complianceScore}% (${passedChecks}/${checks.length})`, 'info');
            log('report-output', `üéØ OVERALL STATUS: ${overallStatus}`, complianceScore >= 90 ? 'success' : 'warning');
            
            if (complianceScore === 100) {
                log('report-output', `üéâ CONGRATULATIONS! LAMS is 100% cloud-based!`, 'success');
            }
        }

        // Auto-run basic checks when page loads
        document.addEventListener('DOMContentLoaded', function() {
            log('architecture-output', 'üöÄ Loading LAMS system...', 'info');
            log('cloud-output', '‚è≥ Initializing cloud verification...', 'info');
            
            // Wait for system initialization before running tests
            waitForSystemInit().then(() => {
                log('architecture-output', '‚úÖ LAMS system initialized successfully', 'success');
                setTimeout(() => {
                    analyzeArchitecture();
                    verifyCloudStructure();
                }, 500);
            });
        });
    </script>
</body>
</html>
