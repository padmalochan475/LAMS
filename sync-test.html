<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAMS - Sync Test</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .test-container {
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
        }
        .test-button {
            padding: 10px 20px;
            margin: 5px;
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .test-button:hover {
            background: #3367d6;
        }
        .test-result {
            margin-top: 10px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background-color: #4caf50; }
        .status-warning { background-color: #ff9800; }
        .status-error { background-color: #f44336; }
        .status-info { background-color: #2196f3; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üî¨ LAMS Sync System Test</h1>
        <p>This page tests the sync functionality and Google Drive integration fixes.</p>

        <!-- Authentication Test -->
        <div class="test-section">
            <h3>üîê Authentication Test</h3>
            <button class="test-button" onclick="testAuth()">Test Sign In</button>
            <button class="test-button" onclick="testSignOut()">Test Sign Out</button>
            <div class="test-result" id="authResult">Click "Test Sign In" to start...</div>
        </div>

        <!-- Sync Timing Test -->
        <div class="test-section">
            <h3>‚è±Ô∏è Sync Timing Test</h3>
            <p>Testing the new 30-second sync interval instead of 3 seconds</p>
            <button class="test-button" onclick="testSyncTiming()">Test Sync Timing</button>
            <button class="test-button" onclick="testManualSync()">Test Manual Sync</button>
            <div class="test-result" id="syncResult">Ready to test sync timing...</div>
        </div>

        <!-- Data Loading Test -->
        <div class="test-section">
            <h3>üìÅ Data Loading Test</h3>
            <p>Testing Google Drive data loading and default data initialization</p>
            <button class="test-button" onclick="testDataLoading()">Test Data Loading</button>
            <button class="test-button" onclick="testDefaultData()">Test Default Data Init</button>
            <div class="test-result" id="dataResult">Ready to test data loading...</div>
        </div>

        <!-- User Activity Test -->
        <div class="test-section">
            <h3>üñ±Ô∏è User Activity Test</h3>
            <p>Testing if sync pauses during user interactions</p>
            <button class="test-button" onclick="testUserActivity()">Simulate User Activity</button>
            <button class="test-button" onclick="checkSyncPause()">Check Sync Pause</button>
            <div class="test-result" id="activityResult">Ready to test user activity tracking...</div>
        </div>

        <!-- Analytics Test -->
        <div class="test-section">
            <h3>üìä Analytics Test</h3>
            <p>Testing the enhanced analytics functionality</p>
            <button class="test-button" onclick="testAnalytics()">Test Analytics</button>
            <button class="test-button" onclick="openMainApp()">Open Main App</button>
            <div class="test-result" id="analyticsResult">Ready to test analytics...</div>
        </div>
    </div>

    <!-- Google APIs -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.0/dist/chart.min.js"></script>

    <!-- Application Scripts -->
    <script src="config.js"></script>
    <script src="auth.js"></script>
    <script src="app.js"></script>

    <script>
        // Test Functions
        async function testAuth() {
            const result = document.getElementById('authResult');
            result.innerHTML = '<span class="status-indicator status-info"></span>Testing authentication...';
            
            try {
                if (window.authManager) {
                    const isSignedIn = window.authManager.isSignedIn;
                result.innerHTML = '<span class="status-indicator status-success"></span>Auth Status: ' + (isSignedIn ? 'Signed In' : 'Not Signed In') + '<br>' +
                    'Auth Manager: Available<br>' +
                    'Google API: ' + (typeof gapi !== 'undefined' ? 'Loaded' : 'Not Loaded');
                } else {
                    result.innerHTML = '<span class="status-indicator status-error"></span>Auth Manager not available';
                }
            } catch (error) {
                result.innerHTML = `<span class="status-indicator status-error"></span>Auth Test Error: ${error.message}`;
            }
        }

        async function testSignOut() {
            const result = document.getElementById('authResult');
            try {
                if (window.authManager && window.authManager.isSignedIn) {
                    await window.authManager.signOut();
                    result.innerHTML = '<span class="status-indicator status-success"></span>Successfully signed out';
                } else {
                    result.innerHTML = '<span class="status-indicator status-warning"></span>Not signed in or auth manager not available';
                }
            } catch (error) {
                result.innerHTML = `<span class="status-indicator status-error"></span>Sign out error: ${error.message}`;
            }
        }

        function testSyncTiming() {
            const result = document.getElementById('syncResult');
            result.innerHTML = '<span class="status-indicator status-info"></span>Checking sync interval...';
            
            if (window.dataManager && window.dataManager.syncInterval) {
                const interval = window.dataManager.syncInterval;
                const seconds = interval / 1000;
                result.innerHTML = '<span class="status-indicator status-success"></span>Sync Interval: ' + seconds + ' seconds<br>' +
                    'Expected: 30 seconds<br>' +
                    'Status: ' + (seconds === 30 ? 'CORRECT ‚úÖ' : 'INCORRECT ‚ùå');
            } else {
                result.innerHTML = '<span class="status-indicator status-warning"></span>Sync interval not available or data manager not loaded';
            }
        }

        async function testManualSync() {
            const result = document.getElementById('syncResult');
            result.innerHTML = '<span class="status-indicator status-info"></span>Testing manual sync...';
            
            try {
                if (window.manualSync) {
                    await window.manualSync();
                    result.innerHTML = '<span class="status-indicator status-success"></span>Manual sync function executed successfully!';
                } else {
                    result.innerHTML = '<span class="status-indicator status-error"></span>Manual sync function not available';
                }
            } catch (error) {
                result.innerHTML = `<span class="status-indicator status-error"></span>Manual sync error: ${error.message}`;
            }
        }

        async function testDataLoading() {
            const result = document.getElementById('dataResult');
            result.innerHTML = '<span class="status-indicator status-info"></span>Testing data loading...';
            
            try {
                if (window.dataManager) {
                    const hasData = window.dataManager.assignments && window.dataManager.assignments.length > 0;
                    const hasSubjects = window.dataManager.subjects && window.dataManager.subjects.length > 0;
                    const hasFaculties = window.dataManager.faculties && window.dataManager.faculties.length > 0;
                    
                    result.innerHTML = '<span class="status-indicator status-success"></span>Data Loading Status:<br>' +
                        'Assignments: ' + (hasData ? 'Available' : 'Empty') + ' (' + (window.dataManager.assignments?.length || 0) + ')<br>' +
                        'Subjects: ' + (hasSubjects ? 'Available' : 'Empty') + ' (' + (window.dataManager.subjects?.length || 0) + ')<br>' +
                        'Faculties: ' + (hasFaculties ? 'Available' : 'Empty') + ' (' + (window.dataManager.faculties?.length || 0) + ')<br>' +
                        'Data Manager: ' + (window.dataManager ? 'Available' : 'Not Available');
                } else {
                    result.innerHTML = '<span class="status-indicator status-error"></span>Data manager not available';
                }
            } catch (error) {
                result.innerHTML = `<span class="status-indicator status-error"></span>Data loading test error: ${error.message}`;
            }
        }

        async function testDefaultData() {
            const result = document.getElementById('dataResult');
            result.innerHTML = '<span class="status-indicator status-info"></span>Testing default data initialization...';
            
            try {
                if (window.dataManager && typeof window.dataManager.initializeDefaultData === 'function') {
                    await window.dataManager.initializeDefaultData();
                    result.innerHTML = '<span class="status-indicator status-success"></span>Default data initialization completed successfully!';
                } else {
                    result.innerHTML = '<span class="status-indicator status-error"></span>Default data initialization function not available';
                }
            } catch (error) {
                result.innerHTML = `<span class="status-indicator status-error"></span>Default data init error: ${error.message}`;
            }
        }

        function testUserActivity() {
            const result = document.getElementById('activityResult');
            result.innerHTML = '<span class="status-indicator status-info"></span>Simulating user activity...';
            
            try {
                // Simulate various user activities
                document.dispatchEvent(new Event('mousemove'));
                document.dispatchEvent(new Event('keydown'));
                document.dispatchEvent(new Event('click'));
                document.dispatchEvent(new Event('scroll'));
                
                result.innerHTML = '<span class="status-indicator status-success"></span>User activity events dispatched:<br>' +
                    '- Mouse movement<br>' +
                    '- Key press<br>' +
                    '- Click<br>' +
                    '- Scroll<br>' +
                    'Check if sync pauses during these activities...';
            } catch (error) {
                result.innerHTML = `<span class="status-indicator status-error"></span>User activity test error: ${error.message}`;
            }
        }

        function checkSyncPause() {
            const result = document.getElementById('activityResult');
            
            try {
                if (window.dataManager && window.dataManager.isUserActive !== undefined) {
                    const isActive = window.dataManager.isUserActive;
                    const lastActivity = window.dataManager.lastUserActivity;
                    const now = Date.now();
                    const timeSinceActivity = lastActivity ? now - lastActivity : 'Unknown';
                    
                    result.innerHTML = '<span class="status-indicator status-success"></span>User Activity Status:<br>' +
                        'Is User Active: ' + isActive + '<br>' +
                        'Last Activity: ' + (lastActivity ? new Date(lastActivity).toLocaleTimeString() : 'Unknown') + '<br>' +
                        'Time Since Activity: ' + (typeof timeSinceActivity === 'number' ? timeSinceActivity + 'ms' : timeSinceActivity) + '<br>' +
                        'Activity Tracking: ' + (window.dataManager.setupUserActivityTracking ? 'Available' : 'Not Available');
                } else {
                    result.innerHTML = '<span class="status-indicator status-warning"></span>User activity tracking data not available';
                }
            } catch (error) {
                result.innerHTML = `<span class="status-indicator status-error"></span>Sync pause check error: ${error.message}`;
            }
        }

        function testAnalytics() {
            const result = document.getElementById('analyticsResult');
            
            try {
                const analyticsAvailable = [
                    'generateSubjectAssignmentChart',
                    'generateFacultyWorkloadChart',
                    'generateAssignmentStatusChart',
                    'generateWeeklyDistributionChart',
                    'generateSubjectFacultyChart',
                    'generateCompletionRateChart',
                    'generateTimelineChart',
                    'generateWorkloadHeatmap'
                ].every(func => typeof window[func] === 'function');

                result.innerHTML = '<span class="status-indicator ' + (analyticsAvailable ? 'status-success' : 'status-error') + '"></span>Analytics Functions:<br>' +
                    (analyticsAvailable ? 'All 8 analytics functions available ‚úÖ' : 'Some analytics functions missing ‚ùå') + '<br><br>' +
                    'Chart.js: ' + (typeof Chart !== 'undefined' ? 'Available ‚úÖ' : 'Not Available ‚ùå') + '<br>' +
                    'Analytics Tab: ' + (document.querySelector('#analytics') ? 'Available ‚úÖ' : 'Not Available ‚ùå');
            } catch (error) {
                result.innerHTML = `<span class="status-indicator status-error"></span>Analytics test error: ${error.message}`;
            }
        }

        function openMainApp() {
            window.open('index.html', '_blank');
        }

        // Initialize when page loads
        window.addEventListener('load', function() {
            console.log('üî¨ Sync Test Page Loaded');
            
            // Wait for scripts to load
            setTimeout(() => {
                testAuth();
                testSyncTiming();
                testDataLoading();
                testAnalytics();
            }, 2000);
        });
    </script>
</body>
</html>
