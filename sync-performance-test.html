<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAMS - Sync Performance Test</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .test-container {
            max-width: 900px;
            margin: 30px auto;
            padding: 30px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
        .performance-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .metric-card {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #4285f4;
        }
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #4285f4;
        }
        .metric-label {
            color: #666;
            margin-top: 5px;
        }
        .test-button {
            padding: 12px 24px;
            margin: 10px;
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }
        .test-button:hover { background: #3367d6; }
        .test-button:disabled { background: #ccc; cursor: not-allowed; }
        .activity-log {
            height: 300px;
            overflow-y: auto;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            margin-top: 15px;
        }
        .log-entry {
            padding: 2px 0;
            border-bottom: 1px solid #eee;
        }
        .log-sync { color: #4285f4; }
        .log-skip { color: #ff9800; }
        .log-activity { color: #4caf50; }
        .log-error { color: #f44336; }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-active { background: #4caf50; }
        .status-paused { background: #ff9800; }
        .status-error { background: #f44336; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>‚ö° LAMS Sync Performance Test</h1>
        <p>Real-time monitoring of sync behavior and dropdown protection</p>

        <div class="performance-grid">
            <div class="metric-card">
                <div class="metric-value" id="syncCount">0</div>
                <div class="metric-label">Sync Attempts</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="skipCount">0</div>
                <div class="metric-label">Sync Skips (Protection)</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="avgInterval">--</div>
                <div class="metric-label">Avg Sync Interval (s)</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="protectionRate">--%</div>
                <div class="metric-label">Protection Efficiency</div>
            </div>
        </div>

        <div style="margin: 30px 0; text-align: center;">
            <button class="test-button" onclick="startMonitoring()" id="startBtn">üöÄ Start Monitoring</button>
            <button class="test-button" onclick="stopMonitoring()" id="stopBtn" disabled>‚èπÔ∏è Stop Monitoring</button>
            <button class="test-button" onclick="simulateDropdownActivity()">üéØ Simulate Dropdown Use</button>
            <button class="test-button" onclick="simulateFormActivity()">üìù Simulate Form Activity</button>
            <button class="test-button" onclick="clearLog()">üóëÔ∏è Clear Log</button>
        </div>

        <div>
            <h3>üîç Real-time Activity Log</h3>
            <div>
                <span class="status-indicator status-active"></span> <strong>Sync Status:</strong> 
                <span id="syncStatus">Not Started</span>
            </div>
            <div class="activity-log" id="activityLog">
                <div class="log-entry">Waiting to start monitoring...</div>
            </div>
        </div>

        <!-- Test Dropdown -->
        <div style="margin-top: 20px;">
            <h3>üß™ Test Elements</h3>
            <select id="testDropdown" onchange="logActivity('User selected dropdown option', 'activity')">
                <option>Select an option...</option>
                <option>Option 1</option>
                <option>Option 2</option>
                <option>Option 3</option>
            </select>
            <input type="text" id="testInput" placeholder="Test input field" onfocus="logActivity('User focused input field', 'activity')" onblur="logActivity('User left input field', 'activity')">
        </div>
    </div>

    <!-- Include Application Scripts -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="config.js"></script>
    <script src="auth.js"></script>
    <script src="app.js"></script>

    <script>
        // Performance monitoring variables
        let monitoringActive = false;
        let monitoringInterval;
        let syncCount = 0;
        let skipCount = 0;
        let syncTimes = [];
        let lastSyncTime = 0;

        // UI update functions
        function updateMetrics() {
            document.getElementById('syncCount').textContent = syncCount;
            document.getElementById('skipCount').textContent = skipCount;
            
            if (syncTimes.length > 1) {
                const avgInterval = syncTimes.reduce((sum, time, index) => {
                    if (index === 0) return sum;
                    return sum + (time - syncTimes[index - 1]);
                }, 0) / (syncTimes.length - 1);
                document.getElementById('avgInterval').textContent = Math.round(avgInterval / 1000);
            }
            
            const totalAttempts = syncCount + skipCount;
            if (totalAttempts > 0) {
                const protectionRate = Math.round((skipCount / totalAttempts) * 100);
                document.getElementById('protectionRate').textContent = protectionRate + '%';
            }
        }

        function logActivity(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('activityLog');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateSyncStatus(status) {
            document.getElementById('syncStatus').textContent = status;
        }

        // Monitoring functions
        function startMonitoring() {
            if (monitoringActive) return;
            
            monitoringActive = true;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            
            logActivity('üöÄ Performance monitoring started', 'sync');
            updateSyncStatus('Monitoring Active');
            
            // Monitor sync behavior every second
            monitoringInterval = setInterval(() => {
                if (window.dataManager) {
                    checkSyncBehavior();
                }
            }, 1000);
            
            // Hook into sync functions if available
            if (window.dataManager && typeof window.dataManager.syncWithCloud === 'function') {
                const originalSync = window.dataManager.syncWithCloud;
                window.dataManager.syncWithCloud = async function(...args) {
                    syncCount++;
                    syncTimes.push(Date.now());
                    logActivity('üîÑ Sync executed', 'sync');
                    updateMetrics();
                    return await originalSync.apply(this, args);
                };
            }
            
            if (window.dataManager && typeof window.dataManager.shouldSkipSync === 'function') {
                const originalShouldSkip = window.dataManager.shouldSkipSync;
                window.dataManager.shouldSkipSync = function(...args) {
                    const result = originalShouldSkip.apply(this, args);
                    if (result) {
                        skipCount++;
                        logActivity('‚è∏Ô∏è Sync skipped - protection active', 'skip');
                        updateMetrics();
                    }
                    return result;
                };
            }
        }

        function stopMonitoring() {
            if (!monitoringActive) return;
            
            monitoringActive = false;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
            }
            
            logActivity('‚èπÔ∏è Performance monitoring stopped', 'sync');
            updateSyncStatus('Monitoring Stopped');
        }

        function checkSyncBehavior() {
            if (!window.dataManager) return;
            
            // Check if sync should be skipped
            if (typeof window.dataManager.shouldSkipSync === 'function') {
                const shouldSkip = window.dataManager.shouldSkipSync();
                const currentTime = Date.now();
                
                // Check various states
                const states = {
                    dropdownOpen: window.dataManager.isDropdownOpen,
                    formActive: window.dataManager.isFormActive,
                    userActive: currentTime - (window.dataManager.lastUserActivity || 0) < 2000,
                    syncInProgress: window.dataManager.isSyncInProgress
                };
                
                let statusText = 'Idle';
                if (states.dropdownOpen) statusText = 'Dropdown Active';
                else if (states.formActive) statusText = 'Form Active';
                else if (states.userActive) statusText = 'User Active';
                else if (states.syncInProgress) statusText = 'Sync In Progress';
                
                updateSyncStatus(statusText);
            }
        }

        // Simulation functions
        function simulateDropdownActivity() {
            logActivity('üéØ Simulating dropdown activity...', 'activity');
            
            const dropdown = document.getElementById('testDropdown');
            
            // Simulate dropdown opening
            dropdown.focus();
            logActivity('üëÜ Dropdown focused', 'activity');
            
            setTimeout(() => {
                // Simulate selection
                dropdown.selectedIndex = 1;
                dropdown.dispatchEvent(new Event('change'));
                logActivity('‚úÖ Dropdown selection made', 'activity');
                
                setTimeout(() => {
                    dropdown.blur();
                    logActivity('üëã Dropdown closed', 'activity');
                }, 1000);
            }, 500);
        }

        function simulateFormActivity() {
            logActivity('üìù Simulating form activity...', 'activity');
            
            const input = document.getElementById('testInput');
            
            // Simulate typing
            input.focus();
            logActivity('üìù Input field focused', 'activity');
            
            let text = 'Test typing...';
            let i = 0;
            
            const typeInterval = setInterval(() => {
                if (i < text.length) {
                    input.value += text[i];
                    input.dispatchEvent(new Event('input'));
                    i++;
                } else {
                    clearInterval(typeInterval);
                    
                    setTimeout(() => {
                        input.blur();
                        logActivity('‚úÖ Form activity completed', 'activity');
                        
                        setTimeout(() => {
                            input.value = '';
                        }, 1000);
                    }, 500);
                }
            }, 100);
        }

        function clearLog() {
            document.getElementById('activityLog').innerHTML = '<div class="log-entry">Log cleared...</div>';
            syncCount = 0;
            skipCount = 0;
            syncTimes = [];
            updateMetrics();
        }

        // Initialize when page loads
        window.addEventListener('load', function() {
            logActivity('üîç Sync Performance Test loaded', 'info');
            
            // Check if required components are available
            setTimeout(() => {
                if (window.dataManager) {
                    logActivity('‚úÖ DataManager detected', 'sync');
                    if (typeof window.dataManager.shouldSkipSync === 'function') {
                        logActivity('‚úÖ Sync protection system detected', 'sync');
                    } else {
                        logActivity('‚ùå Sync protection system not found', 'error');
                    }
                } else {
                    logActivity('‚ùå DataManager not found', 'error');
                }
                
                if (window.authManager) {
                    logActivity('‚úÖ AuthManager detected', 'sync');
                } else {
                    logActivity('‚ùå AuthManager not found', 'error');
                }
            }, 2000);
        });

        // Monitor actual user interactions
        document.addEventListener('focus', (e) => {
            if (e.target.tagName === 'SELECT' || e.target.tagName === 'INPUT') {
                logActivity(`üëÜ User focused ${e.target.tagName.toLowerCase()}`, 'activity');
            }
        }, true);

        document.addEventListener('blur', (e) => {
            if (e.target.tagName === 'SELECT' || e.target.tagName === 'INPUT') {
                logActivity(`üëã User left ${e.target.tagName.toLowerCase()}`, 'activity');
            }
        }, true);

        document.addEventListener('change', (e) => {
            if (e.target.tagName === 'SELECT') {
                logActivity(`üéØ User changed ${e.target.tagName.toLowerCase()} selection`, 'activity');
            }
        }, true);
    </script>
</body>
</html>
